<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>

        body{
            font-family: "American Typewriter";
        }

        #snake{
            display: grid;
            text-align: center;

        }

        #meny{
            display: grid;
            grid-template-columns: 1fr 1fr 1fr ;
            text-align: center;
        }
        #gameOn{
            position: absolute;
            top: 40%;
            left: 35%;
            opacity: 0;
            color: red;
            text-align: center;
            font-size: 50px;
        }



    </style>
</head>
<body>

<h1 id="snake">snake</h1>

<div id="meny">
    <button id="play">play</button>
    <h3 id="points">poeng</h3>
    <h3 id="highscore">highscore:</h3>
</div>

<canvas id="canvas" height="600" width="1420"></canvas>

<div id="gameOn">
    <h3>GAME OVER!</h3>
    <p>press play!</p>

</div>




<script>
    //referer til html elementer
    const canvas = document.querySelector("#canvas");
    const ctx = canvas.getContext("2d");
    let theGameIsOn = true;
    let points = document.querySelector("#points");
    let highscore = document.querySelector("#highscore");
    let gameOn = document.querySelector("#gameOn");
    let play = document.querySelector("#play");

    //globale variabler

    let fart = 2;
    let boksSide = 40;
    let farge = "green";

    //teller
    let poeng = 0;


    let bane = {
        bredde: canvas.width,
        hoyde: canvas.height,
        farge: "black",
    };

    let mat = {
        side: 40,
        farge: "red",
        xpos: Math.floor(Math.random()*(bane.bredde - 40)),
        ypos: Math.floor(Math.random()*(bane.hoyde - 40))
    };

    let slange = [];

    //bilder:

    //eple bildet
    let epleBilde = new Image();
    epleBilde.src = "apple.png";

    //slangeskinnet bildet
    let slangeSkinn = new Image();
    slangeSkinn.src = "snakeskin.jpg";

    //bakgrunnsbilde
    let bakgrunn = new Image();
    bakgrunn.src = "bakgrunn.jpg";


    //setter highscoren til 0 helt i starten
    if (localStorage.rekord === undefined){
        localStorage.rekord = 0;
    }
    highscore.innerHTML = "Highscore: " + localStorage.rekord;



    //Setup

    lagBoks(mat.xpos-50,mat.ypos+19, 1,0);
    gameLoop();


    //gameloop
    function gameLoop() {

        flyttSlange();
        tegnBane();
        tegnMat();
        sjekkMat();
        leggTilPoeng();
        tegnSlange();
        sjekkGameOver();
        if (theGameIsOn){
            requestAnimationFrame(gameLoop);
        }

    }


    //funksjoner

    //tegner bane
    function tegnBane() {
        ctx.fillStyle = bane.farge;
        ctx.drawImage(bakgrunn,0,0,bane.bredde, bane.hoyde);
    }


    //tegner mat
    function tegnMat(){
        ctx.drawImage(epleBilde, mat.xpos, mat.ypos, mat.side, mat.side)
    }

    //looper gjennom slangen sine bokser og endrer x og y posisjonen deres slik at de flytter på seg
    function flyttSlange (){

        for (let boks of slange) {
            boks.xpos = boks.xpos + (fart * boks.xretning);
            boks.ypos = boks.ypos + (fart * boks.yretning);
        }

    }

    // tegner slangen med boksene
    function tegnSlange (){

        for (let boks of slange) {
            ctx.fillStyle = farge;
            ctx.drawImage(slangeSkinn,boks.xpos, boks.ypos, boksSide, boksSide);
        }

        //får boksen til å endre retning slik som den første boksen gjør
        for (let i = 1; i < slange.length; i++) {

            //hvis boksen beveger seg loddrett
            if(slange[i].xretning === 0){
                //sjekker om ypos til boksen er lik ypos til den første boksen som har snudd
                if (slange[i].ypos === slange[i-1].ypos){
                    //endrer retningen på boksen vi er på slik at den har samme retning som boksen foran
                    slange[i].xretning = slange[i-1].xretning;
                    slange[i].yretning = slange[i-1].yretning;
                }

            }
            //hvis boksen beveger seg vannrett
            else if (slange[i].yretning === 0){
                //sjekker
                if (slange[i].xpos === slange[i-1].xpos){
                    slange[i].xretning = slange[i-1].xretning;
                    slange[i].yretning = slange[i-1].yretning;
                }
            }
        }
    }


    function lagBoks(xpos, ypos, xret, yret){
        let boks = {
            xpos: xpos,
            ypos: ypos,
            xretning: xret,
            yretning: yret

        };

        slange.push(boks)

    }


    //sjekker om den første boksen er innenfor matboksen og hvis den er det lager den en boks bakerst i rekken.
    // hvis den siste boksen beveger seg loddrett
    function sjekkMat(){
        if ((slange[0].xpos > mat.xpos - boksSide && slange[0].xpos < mat.xpos + mat.side) && (slange[0].ypos > mat.ypos - boksSide && slange[0].ypos < mat.ypos + mat.side)) {

            //legger til et poeng i poeng telleren for hver gang man treffer en matbit
            poeng += 1;
            if (poeng > localStorage.rekord){
                localStorage.rekord = poeng;
                highscore.innerHTML = "highscore:" + poeng;
            }

            //hvis bakerste beveger seg oppover
            if (slange[slange.length-1].yretning === -1) {
                //lages en boks som plasseres under med lik xpos som boksen over og ypos 20 unna ypos til boksen foran avhengig av retningen til boksen foran, med retning oppover
                lagBoks(slange[slange.length-1].xpos, slange[slange.length-1].ypos+boksSide,0,-1)

            }
            //hvis bakerste beveger seg nedover
            else if(slange[slange.length-1].yretning === 1){
                //lages en boks som plasseres over bakerste boks med retning nedover
                lagBoks(slange[slange.length-1].xpos , slange[slange.length-1].ypos-boksSide,0,1)
            }
            //hvis bakerste beveger seg left
            else if(slange[slange.length-1].xretning === -1){
                //lages en boks som plasseres til høyre med retning mot venstre
                lagBoks(slange[slange.length-1].xpos+boksSide, slange[slange.length-1].ypos,-1,0)
            }
            //hvis bakerste beveger seg right
            else if(slange[slange.length-1].xretning === 1){
                //lages en boks som plasseres til venstre med retning mot høyre
                lagBoks(slange[slange.length-1].xpos-boksSide, slange[slange.length-1].ypos,1,0)
            }

            //når en ny slangeboks er lagt til flytter matboksen seg til et nytt tifeldig sted
            mat.xpos = Math.floor(Math.random()*bane.bredde);
            mat.ypos = Math.floor(Math.random()*bane.hoyde);

        }

    }

    //sjekker om slangen treffer sin egen kropp
    function sjekkGameOver() {

        //looper gjennom alle boksene i slangen og sjekker om den første boksen treffer noen av de andre boksene. dersom den gjør det blir gameIsOn lik false
        for (let i = 2; i < slange.length; i++){
            if ((slange[0].xpos > slange[i].xpos - boksSide && slange[0].xpos < slange[i].xpos + boksSide) && (slange[0].ypos > slange[i].ypos - boksSide && slange[0].ypos < slange[i].ypos+boksSide)){
                gameOver()
            }

        }
        if (slange[0].xpos < 0 || slange[0].xpos > bane.bredde - boksSide || slange[0].ypos < 0 || slange[0].ypos > bane.hoyde-boksSide){
            gameOver()
        }

    }


    //alt som skjer når game over
    function gameOver() {
        theGameIsOn = false;
        gameOn.style.opacity = 1;


    }





    //funksjon som legger til poengene i html elementet "poeng"
    function leggTilPoeng(){

        points.innerHTML = `poeng: ${poeng}`

    }






    //hendelsesfunksjoner

    window.onkeydown = function () {
        console.log(event.code);


        //endre retningen til den første boksen

            if (event.code === "ArrowUp") {

                //hvis første boks er innenfor boksen bak sine xpos endres IKKE retningen
                if (slange[0].xpos > slange[1].xpos-boksSide && slange[0].xpos < slange[1].xpos+boksSide) {

                }

                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på IKKE retningen
                else if (slange[0].yretning === 1 ){
                    slange[0].yretning = 1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = -1;
                    slange[0].xretning = 0;
                }
            }
            else if (event.code === "ArrowDown") {

                //hvis første boks er innenfor boksen bak sine xpos endres IKKE retningen
                if (slange[0].xpos > slange[1].xpos-boksSide && slange[0].xpos < slange[1].xpos+boksSide) {
                }

                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].yretning === -1){
                    slange[0].yretning = -1;
                }

                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 1;
                    slange[0].xretning = 0;
                }
            }
            else if (event.code === `ArrowRight`) {
                //hvis første boks er innenfor boksen bak sine ypos endres IKKE retningen
                if (slange[0].ypos > slange[1].ypos-boksSide && slange[0].ypos < slange[1].ypos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].xretning === -1){
                    slange[0].yretning = -1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 0;
                    slange[0].xretning = 1;
                }
            }
            else if (event.code === `ArrowLeft`) {
                //hvis første boks er innenfor boksen bak sine ypos endres IKKE retningen
                if (slange[0].ypos > slange[1].ypos-boksSide && slange[0].ypos < slange[1].ypos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].xretning === 1 || (slange[0].ypos > slange[1].ypos -boksSide && slange[0].ypos < slange[1].ypos + boksSide)){
                    slange[0].xretning = 1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 0;
                    slange[0].xretning = -1;
                }

            }
    }




    play.onclick = function() {
        if (!theGameIsOn) {
            location.reload();
        }
    }


















</script>

</body>
</html>