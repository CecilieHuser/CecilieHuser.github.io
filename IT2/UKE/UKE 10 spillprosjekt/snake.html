<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>

        body{
            font-family: "American Typewriter";
        }

        #snake{
            display: grid;
            text-align: center;
            color: #4CAF50;

        }

        #meny{
            display: grid;
            grid-template-columns: 1fr 1fr;
            text-align: center;
            padding: 20px;


        }
        #gameOn{
            position: absolute;
            top: 40%;
            left: 35%;
            opacity: 0;
            color: red;
            text-align: center;
            font-size: 50px;
        }

        #play{
            font-family: "American Typewriter";
            padding: 20px;
            font-size: 40px;
            background-color: white;
        }
        #remove{
            font-family: "American Typewriter";
            padding: 5px;
            color: white;
            background-color: black;
        }



    </style>
</head>
<body>

<h1 id="snake">SNAKE</h1>

<div id="meny">
    <a id="points">points</a>
    <div>
        <a id="highscore"> highscore: </a>
        <button id="remove">remove</button>
    </div>



</div>

<canvas id="canvas" height="600" width="1420"></canvas>

<div id="gameOn">
    <h3>GAME OVER!</h3>
    <button id="play">PLAY</button>

</div>




<script>
    //referer til html elementer
    const canvas = document.querySelector("#canvas");
    const ctx = canvas.getContext("2d");
    let theGameIsOn = true;
    let points = document.querySelector("#points");
    let highscore = document.querySelector("#highscore");
    let gameOn = document.querySelector("#gameOn");
    let play = document.querySelector("#play");
    let remove = document.querySelector("#remove");

    //globale variabler
    let fart = 2.5;
    let boksSide = 40;

    //teller
    let poeng = 0;

    //bane
    let bane = {
        bredde: canvas.width,
        hoyde: canvas.height,
    };

    //mat
    let mat = {
        side: 40,
        xpos: Math.floor(Math.random()*(bane.bredde - 40)),
        ypos: Math.floor(Math.random()*(bane.hoyde - 40))
    };

    //tom slangearray
    let slange = [];

    //bilder:

    //eple bildet
    let epleBilde = new Image();
    epleBilde.src = "apple.png";

    //slangeskinnet bildet
    let slangeSkinn = new Image();
    slangeSkinn.src = "snakeskin.jpg";

    //bakgrunnsbilde
    let bakgrunn = new Image();
    bakgrunn.src = "bakgrunn.jpg";


    //setter highscoren til 0 helt i starten
    if (localStorage.rekord === undefined){
        localStorage.rekord = 0;
    }
    highscore.innerHTML = "Highscore: " + localStorage.rekord;

    //Setup
    lagBoks(mat.xpos-50,mat.ypos+19, 1,0);
    gameLoop();

    //gameloop
    function gameLoop() {
        flyttSlange();
        tegnBane();
        tegnMat();
        sjekkMat();
        leggTilPoeng();
        tegnSlange();
        sjekkGameOver();
        if (theGameIsOn){
            requestAnimationFrame(gameLoop);
        }
    }

    //funksjoner

    //tegner bane
    function tegnBane() {
        ctx.fillStyle = bane.farge;
        ctx.drawImage(bakgrunn,0,0,bane.bredde, bane.hoyde);
    }

    //tegner mat
    function tegnMat(){
        ctx.drawImage(epleBilde, mat.xpos, mat.ypos, mat.side, mat.side)
    }

    //looper gjennom slangen sine bokser og endrer x og y posisjonen deres slik at de flytter på seg
    function flyttSlange (){

        for (let boks of slange) {
            boks.xpos = boks.xpos + (fart * boks.xretning);
            boks.ypos = boks.ypos + (fart * boks.yretning);
        }

    }

    // tegner slangen med boksene
    function tegnSlange (){
        for (let boks of slange) {
            ctx.drawImage(slangeSkinn,boks.xpos, boks.ypos, boksSide, boksSide);
        }
        //får boksen til å endre retning slik som den første boksen gjør
        for (let i = 1; i < slange.length; i++) {
            //hvis boksen beveger seg loddrett
            if(slange[i].xretning === 0){
                //sjekker om ypos til boksen vi er på er lik ypos til boksen foran, dersom den er det så har boksen foran snudd
                if (slange[i].ypos === slange[i-1].ypos){
                    //endrer retningen på boksen vi er på slik at den har samme retning som boksen foran
                    slange[i].xretning = slange[i-1].xretning;
                    slange[i].yretning = slange[i-1].yretning;
                }
            }
            //hvis boksen beveger seg vannrett
            else if (slange[i].yretning === 0){
                //sjekker om xpos til boksen vi er på er lik xpos til boksen foran, dersom den er det så har boksen foran snudd
                if (slange[i].xpos === slange[i-1].xpos){
                    //endrer retningen på boksen vi er på slik at den har samme retning som boksen foran
                    slange[i].xretning = slange[i-1].xretning;
                    slange[i].yretning = slange[i-1].yretning;
                }
            }
        }
    }

    //funksjon som lager boks med parametere for x og y retning og posisjon
    function lagBoks(xpos, ypos, xret, yret){
        let boks = {
            xpos: xpos,
            ypos: ypos,
            xretning: xret,
            yretning: yret
        };
        //legger til boksen i slange arrayen
        slange.push(boks)
    }

    //sjekker om den første boksen er innenfor matboksen
    function sjekkMat(){
        if ((slange[0].xpos > mat.xpos - boksSide && slange[0].xpos < mat.xpos + mat.side) && (slange[0].ypos > mat.ypos - boksSide && slange[0].ypos < mat.ypos + mat.side)) {
            //legger til et poeng i poeng telleren for hver gang man treffer en matbit
            poeng += 1;
            //hvis poeng er høyere en highscoren endre highscoren likt med poengene
            if (poeng > localStorage.rekord){
                localStorage.rekord = poeng;
                highscore.innerHTML = "highscore:" + poeng;
            }

            //hvis bakerste beveger seg oppover
            if (slange[slange.length-1].yretning === -1) {
                //lages en boks som plasseres under bakerste boks med retning oppover
                lagBoks(slange[slange.length-1].xpos, slange[slange.length-1].ypos+boksSide,0,-1)
            }
            //hvis bakerste beveger seg nedover
            else if(slange[slange.length-1].yretning === 1){
                //lages en boks som plasseres over bakerste boks med retning nedover
                lagBoks(slange[slange.length-1].xpos , slange[slange.length-1].ypos-boksSide,0,1)
            }
            //hvis bakerste beveger seg til venstre
            else if(slange[slange.length-1].xretning === -1){
                //lages en boks som plasseres til høyre med retning mot venstre
                lagBoks(slange[slange.length-1].xpos+boksSide, slange[slange.length-1].ypos,-1,0)
            }
            //hvis bakerste beveger seg høyre
            else if(slange[slange.length-1].xretning === 1){
                //lages en boks som plasseres til venstre med retning mot høyre
                lagBoks(slange[slange.length-1].xpos-boksSide, slange[slange.length-1].ypos,1,0)
            }
            //når en ny slangeboks er lagt til flytter matboksen seg til et nytt tifeldig sted
            mat.xpos = Math.floor(Math.random()*(bane.bredde-mat.side));
            mat.ypos = Math.floor(Math.random()*(bane.hoyde-mat.side));
        }
    }

    //sjekker om slangen treffer sin egen kropp eller veggen
    function sjekkGameOver() {
        //looper gjennom alle boksene i slangen og sjekker om den første boksen treffer noen av de andre boksene. dersom den gjør det bruker jeg gameOver funksjonen
        for (let i = 2; i < slange.length; i++){
            if ((slange[0].xpos > slange[i].xpos - boksSide && slange[0].xpos < slange[i].xpos + boksSide) && (slange[0].ypos > slange[i].ypos - boksSide && slange[0].ypos < slange[i].ypos+boksSide)){
                gameOver()
            }
        }
        //hvis første boksen treffer veggen bruker jeg funksjonen game over.
        if (slange[0].xpos < 0 || slange[0].xpos > bane.bredde - boksSide || slange[0].ypos < 0 || slange[0].ypos > bane.hoyde-boksSide){
            gameOver()
        }
    }

    //alt som skjer når game over
    function gameOver() {
        theGameIsOn = false;
        gameOn.style.opacity = 1;
    }

    //funksjon som legger til poengene i html elementet "poeng"
    function leggTilPoeng(){
        points.innerHTML = `points: ${poeng}`
    }

    //hendelsesfunksjoner

    //styre slangen med piltastene
    window.onkeydown = function () {
        console.log(event.code);
        //endre retningen til den første boksen
            if (event.code === "ArrowUp") {
                //hvis første boks er innenfor boksen bak sine xpos endres IKKE retningen
                if (slange[0].xpos > slange[1].xpos-boksSide && slange[0].xpos < slange[1].xpos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].yretning === 1 ){
                    slange[0].yretning = 1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = -1;
                    slange[0].xretning = 0;
                }
            }
            else if (event.code === "ArrowDown") {
                //hvis første boks er innenfor boksen bak sine xpos endres IKKE retningen
                if (slange[0].xpos > slange[1].xpos-boksSide && slange[0].xpos < slange[1].xpos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].yretning === -1){
                    slange[0].yretning = -1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 1;
                    slange[0].xretning = 0;
                }
            }
            else if (event.code === `ArrowRight`) {
                //hvis første boks er innenfor boksen bak sine ypos endres IKKE retningen
                if (slange[0].ypos > slange[1].ypos-boksSide && slange[0].ypos < slange[1].ypos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].xretning === -1){
                    slange[0].yretning = -1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 0;
                    slange[0].xretning = 1;
                }
            }
            else if (event.code === `ArrowLeft`) {
                //hvis første boks er innenfor boksen bak sine ypos endres IKKE retningen
                if (slange[0].ypos > slange[1].ypos-boksSide && slange[0].ypos < slange[1].ypos+boksSide) {
                }
                //hvis første boksen beveger seg i motsatt retning av pilen du trykker på endres IKKE retningen
                else if (slange[0].xretning === 1 || (slange[0].ypos > slange[1].ypos -boksSide && slange[0].ypos < slange[1].ypos + boksSide)){
                    slange[0].xretning = 1;
                }
                //ellers endres retningen til den første boksen til retningen av pilen du trykker på
                else {
                    slange[0].yretning = 0;
                    slange[0].xretning = -1;
                }
            }
    };

    //når man trykker på play knappen reloader siden og starter spillet på nytt
    play.onclick = function() {
        if (!theGameIsOn) {
            location.reload();
        }
    };
    //fjerner highscoren
    remove.onclick = function () {
        //den kan kun fjernes dersom du ikke har highscoren i spillet du spiller nå
        if (poeng < localStorage.rekord) {
            localStorage.rekord = 0;
            console.log(localStorage.rekord);
            highscore.innerHTML = "Highscore: " + localStorage.rekord;
        }
    }

</script>

</body>
</html>